name: Deploy Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'me_system_frontend/**'
      - '.github/workflows/deploy-frontend.yml'
      - 'docker-compose.prod.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  FRONTEND_IMAGE: me-system-frontend

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Frontend Docker image
        run: |
          cd me_system_frontend
          docker build -t ${{ env.FRONTEND_IMAGE }} .
          docker save -o frontend.tar ${{ env.FRONTEND_IMAGE }}

      - name: Upload Frontend image
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: me_system_frontend/frontend.tar
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Frontend image
        uses: actions/download-artifact@v4
        with:
          name: frontend-image
          path: ./artifacts

      - name: Create SSH directory
        run: mkdir -p ~/.ssh

      - name: Add Host to Known Hosts
        run: ssh-keyscan ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set Correct Permissions
        run: chmod 600 ~/.ssh/known_hosts

      - name: Copy Frontend image to server
        run: |
          scp -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            ./artifacts/frontend.tar \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:/tmp/

      - name: Copy deployment files to server
        run: |
          scp -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            docker-compose.prod.yml \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }}:~/me_system/

      - name: Deploy Frontend to DigitalOcean
        run: |
          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=60 \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_IP }} << 'EOF'
            set -e
            
            # Navigate to deployment directory
            cd ~/me_system
            
            # Load Frontend Docker image
            echo "Loading Frontend Docker image..."
            docker load -i /tmp/frontend.tar
            
            # Clean up transferred image
            rm /tmp/frontend.tar
            
            # Create .env file from secrets (if not exists)
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cat > .env << 'ENVEOF'
          DEBUG=${{ secrets.DEBUG }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          NEXT_PUBLIC_API_URL=http://backend:8000
          ENVEOF
            fi
            
            # Stop existing frontend container
            echo "Stopping existing frontend container..."
            docker-compose -f docker-compose.prod.yml stop frontend || true
            docker-compose -f docker-compose.prod.yml rm -f frontend || true
            
            # Start new frontend container
            echo "Starting new frontend container..."
            docker-compose -f docker-compose.prod.yml up -d frontend
            
            # Wait for frontend to be ready
            sleep 5
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -f
            
            echo "Frontend deployment completed successfully!"
          EOF

